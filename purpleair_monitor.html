<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PurpleAir Sensor Monitor</title>
    <link rel="icon" href="https://map.purpleair.com/favicon.ico" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .data-card {
            transition: all 0.3s ease-in-out;
            background-color: white;
            border: 1px solid #e2e8f0;
        }
        .data-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Custom spinner animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto">
        <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-indigo-600">PurpleAir Sensor Monitor</h1>
                <p class="text-gray-500 mt-2">Displaying air quality data from a pre-configured sensor.</p>
            </div>

            <!-- Input Form -->
            <!-- Message Area -->
            <div id="message" class="mt-4 text-center text-gray-500 font-medium">Loading sensor data...</div>

            <!-- Data Display -->
            <div id="sensorDataContainer" class="mt-8 hidden">
                <h2 class="text-2xl font-semibold text-center mb-6">Sensor Readings</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- PM1.0 -->
                    <div class="data-card p-5 rounded-lg text-center">
                        <h3 class="text-lg font-medium text-gray-500">PM1.0</h3>
                        <p id="pm10" class="text-4xl font-bold mt-2">-</p>
                        <p class="text-xs text-gray-400 mt-1">(μg/m³)</p>
                    </div>
                    <!-- PM2.5 -->
                    <div class="data-card p-5 rounded-lg text-center">
                        <h3 class="text-lg font-medium text-gray-500">PM2.5</h3>
                        <p id="pm25" class="text-4xl font-bold mt-2">-</p>
                        <p class="text-xs text-gray-400 mt-1">(μg/m³)</p>
                    </div>
                    <!-- PM10.0 -->
                    <div class="data-card p-5 rounded-lg text-center">
                        <h3 class="text-lg font-medium text-gray-500">PM10.0</h3>
                        <p id="pm100" class="text-4xl font-bold mt-2">-</p>
                        <p class="text-xs text-gray-400 mt-1">(μg/m³)</p>
                    </div>
                    <!-- Corrected Temperature -->
                    <div class="data-card p-5 rounded-lg text-center">
                        <h3 class="text-lg font-medium text-gray-500">Temperature</h3>
                        <p id="temperature" class="text-4xl font-bold mt-2">-</p>
                        <p class="text-xs text-gray-400 mt-1">(Corrected using Lance Wallace's method)</p>
                    </div>
                    <!-- Corrected Humidity -->
                    <div class="data-card p-5 rounded-lg text-center">
                        <h3 class="text-lg font-medium text-gray-500">Humidity</h3>
                        <p id="humidity" class="text-4xl font-bold mt-2">-</p>
                         <p class="text-xs text-gray-400 mt-1">(Corrected using Lance Wallace's method)</p>
                    </div>
                     <!-- Last Seen -->
                     <div class="data-card p-5 rounded-lg text-center">
                        <h3 class="text-lg font-medium text-gray-500">Last Seen</h3>
                        <p id="lastSeen" class="text-3xl font-bold text-indigo-600 mt-2">-</p>
                         <p class="text-xs text-gray-400 mt-1">(local time)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        // REPLACE with your actual PurpleAir API Read Key
        const API_KEY = 'YOUR_API_KEY_HERE'; 
        // REPLACE with your desired PurpleAir Sensor Index
        const SENSOR_INDEX = 'SENSOR_INDEX'; // Example sensor index

        const messageEl = document.getElementById('message');
        const sensorDataContainer = document.getElementById('sensorDataContainer');

        // Data display elements
        const temperatureEl = document.getElementById('temperature');
        const humidityEl = document.getElementById('humidity');
        const pm10El = document.getElementById('pm10');
        const pm25El = document.getElementById('pm25');
        const pm100El = document.getElementById('pm100');
        const lastSeenEl = document.getElementById('lastSeen');

        window.addEventListener('DOMContentLoaded', fetchSensorData);

        async function fetchSensorData() {
            displayMessage('Loading sensor data...');
            sensorDataContainer.classList.add('hidden');

            // Request only the fields that are being displayed on the page.
            const fields = 'temperature,humidity,pm1.0,pm2.5,pm10.0,last_seen';
            const API_URL = `https://api.purpleair.com/v1/sensors/${SENSOR_INDEX}?fields=${fields}`;

            try {
                const response = await fetch(API_URL, {
                    headers: {
                        'X-API-Key': API_KEY
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.description || `HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                updateUI(data.sensor);
                displayMessage(''); // Clear loading message

            } catch (error) {
                console.error('Fetch error:', error);
                displayMessage(`Error: ${error.message}. Check your API key and sensor index.`);
                sensorDataContainer.classList.add('hidden');
            }
        }
        
        function updateUI(sensor) {
            // Apply Lance Wallace's correction methods
            // Temperature Correction: temp = 1.0227 * raw_temp_f - 9.3755
            const correctedTemp = (1.0227 * sensor.temperature - 9.3755).toFixed(0); 

            // Humidity Correction: 1.4498 * raw_relative_humidity + 7.022
            const correctedHumidity = (1.4498 * sensor.humidity + 7.022).toFixed(0);

            temperatureEl.textContent = `${correctedTemp}°F`;
            updateGradientColor(temperatureEl, correctedTemp, 'temperature');
            
            humidityEl.textContent = `${correctedHumidity}%`;
            updateGradientColor(humidityEl, correctedHumidity, 'humidity');
            
            // PM1.0 value and color update
            const pm10Value = sensor['pm1.0'];
            pm10El.textContent = pm10Value.toFixed(1);
            updatePmColor(pm10El, pm10Value, 'pm1.0');

            // PM2.5 value and color update
            const pm25Value = sensor['pm2.5'];
            pm25El.textContent = pm25Value.toFixed(1);
            updatePmColor(pm25El, pm25Value, 'pm2.5');

            // PM10.0 value and color update
            const pm100Value = sensor['pm10.0'];
            pm100El.textContent = pm100Value.toFixed(1);
            updatePmColor(pm100El, pm100Value, 'pm10.0');
            
            const lastSeenDate = new Date(sensor.last_seen * 1000);
            lastSeenEl.textContent = lastSeenDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
            updateLastSeenColor(lastSeenEl, sensor.last_seen);


            sensorDataContainer.classList.remove('hidden');
        }

        function displayMessage(msg) {
            messageEl.textContent = msg;
        }

        function updatePmColor(element, value, type) {
            // Reset inline style in case it was set by another function
            element.style.color = '';
            const colorClasses = ['text-green-600', 'text-yellow-600', 'text-orange-600', 'text-red-600', 'text-indigo-600'];
            element.classList.remove(...colorClasses);
            
            let newColorClass = 'text-indigo-600'; // Default

            if (type === 'pm2.5' || type === 'pm1.0') {
                if (value < 12) newColorClass = 'text-green-600';
                else if (value >= 12 && value <= 35) newColorClass = 'text-yellow-600';
                else if (value > 35 && value <= 55) newColorClass = 'text-orange-600';
                else if (value > 55) newColorClass = 'text-red-600';
            } else if (type === 'pm10.0') {
                if (value < 54) newColorClass = 'text-green-600';
                else if (value >= 54 && value <= 154) newColorClass = 'text-yellow-600';
                else if (value > 154 && value <= 254) newColorClass = 'text-orange-600';
                else if (value > 254) newColorClass = 'text-red-600';
            }
            
            element.classList.add(newColorClass);
        }

        function updateLastSeenColor(element, lastSeenTimestamp) {
            const now = Date.now(); // current time in milliseconds
            const lastSeenMillis = lastSeenTimestamp * 1000;
            const minutesAgo = (now - lastSeenMillis) / (1000 * 60);

            const colorClasses = ['text-green-600', 'text-yellow-600', 'text-orange-600', 'text-red-600', 'text-indigo-600'];
            element.classList.remove(...colorClasses);

            let newColorClass;

            if (minutesAgo < 10) {
                newColorClass = 'text-green-600'; // Less than 10 minutes
            } else if (minutesAgo <= 60) {
                newColorClass = 'text-yellow-600'; // 10-60 minutes
            } else if (minutesAgo <= 360) { // 1-6 hours
                newColorClass = 'text-orange-600';
            } else { // More than 6 hours
                newColorClass = 'text-red-600';
            }

            element.classList.add(newColorClass);
        }

        function interpolateColor(value, colorPoints) {
            // Find the two points the value is between
            let p1 = colorPoints[0];
            let p2 = colorPoints[colorPoints.length - 1];

            if (value <= p1[0]) return `rgb(${p1[1].join(',')})`;
            if (value >= p2[0]) return `rgb(${p2[1].join(',')})`;

            for (let i = 0; i < colorPoints.length - 1; i++) {
                if (value >= colorPoints[i][0] && value <= colorPoints[i + 1][0]) {
                    p1 = colorPoints[i];
                    p2 = colorPoints[i + 1];
                    break;
                }
            }

            // Calculate interpolation factor
            const factor = (p2[0] - p1[0] === 0) ? 1 : (value - p1[0]) / (p2[0] - p1[0]);

            // Interpolate RGB values
            const r = Math.round(p1[1][0] + factor * (p2[1][0] - p1[1][0]));
            const g = Math.round(p1[1][1] + factor * (p2[1][1] - p1[1][1]));
            const b = Math.round(p1[1][2] + factor * (p2[1][2] - p1[1][2]));

            return `rgb(${r}, ${g}, ${b})`;
        }

        function updateGradientColor(element, value, type) {
            // Remove any Tailwind color classes first
            const colorClasses = ['text-blue-600', 'text-green-600', 'text-red-600', 'text-yellow-500', 'text-indigo-600'];
            element.classList.remove(...colorClasses);

            let color;
            const numericValue = parseFloat(value);
            if (isNaN(numericValue)) return;

            if (type === 'temperature') {
                const tempPoints = [
                    [45, [37, 99, 235]],  // Blue
                    [70, [22, 163, 74]],   // Green
                    [90, [220, 38, 38]]    // Red
                ];
                color = interpolateColor(numericValue, tempPoints);
            } else if (type === 'humidity') {
                const humidityPoints = [
                    [0,  [234, 179, 8]],   // Yellow
                    [40, [22, 163, 74]],   // Green
                    [80, [37, 99, 235]]    // Blue
                ];
                color = interpolateColor(numericValue, humidityPoints);
            }
            element.style.color = color;
        }
    </script>

</body>
</html>



